(window.webpackJsonp=window.webpackJsonp||[]).push([[11],{356:function(t,e,a){"use strict";a.r(e);var s=a(42),r=Object(s.a)({},(function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"jmx-exporter-prometheus"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#jmx-exporter-prometheus"}},[t._v("#")]),t._v(" JMX Exporter & Prometheus")]),t._v(" "),a("h2",{attrs:{id:"export-the-metrics"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#export-the-metrics"}},[t._v("#")]),t._v(" Export the metrics!")]),t._v(" "),a("h3",{attrs:{id:"jmx-exporter"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#jmx-exporter"}},[t._v("#")]),t._v(" JMX Exporter")]),t._v(" "),a("p",[t._v("We will now see how to export JMX metrics. In order to do that, we are going to use the "),a("a",{attrs:{href:"https://github.com/prometheus/jmx_exporter",target:"_blank",rel:"noopener noreferrer"}},[t._v("JMX Exporter project"),a("OutboundLink")],1),t._v(".")]),t._v(" "),a("blockquote",[a("p",[t._v("JMX to Prometheus exporter: a collector that can configurably scrape and expose mBeans of a JMX target.")])]),t._v(" "),a("p",[t._v("JMX Exporter is a Java agent attached to the JVM of the brokers and the ZooKeeper nodes.")]),t._v(" "),a("div",{staticStyle:{"text-align":"center"}},[a("img",{attrs:{src:"prometheus.png",alt:"Kafka Clients"}})]),t._v(" "),a("p",[t._v("Each JMX Exporter agent creates an HTTP server and exposes JMX Metrics and so Prometheus will scrap those metrics.")]),t._v(" "),a("h3",{attrs:{id:"the-prometheus-monitoring-system-and-time-series-database"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#the-prometheus-monitoring-system-and-time-series-database"}},[t._v("#")]),t._v(" The Prometheus monitoring system and time series database.")]),t._v(" "),a("div",{staticStyle:{"text-align":"center"}},[a("img",{attrs:{src:"prometheus_logo.png"}})]),t._v(" "),a("blockquote",[a("p",[t._v("Prometheus is an open-source system monitoring and alerting toolkit originally built at SoundCloud.\nPrometheus, a Cloud Native Computing Foundation project, is a system and service monitoring system.\nIt collects metrics from configured targets at given intervals, evaluates rule expressions, displays the results, and can trigger alerts if some condition is observed to be true.")])]),t._v(" "),a("p",[t._v("You can discover and learn more about Prometheus "),a("a",{attrs:{href:"https://prometheus.io/docs/introduction/overview/",target:"_blank",rel:"noopener noreferrer"}},[t._v("here"),a("OutboundLink")],1),t._v(".")]),t._v(" "),a("p",[t._v("Stop your Kafka cluster to add the JMX Exporter")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[t._v("docker-compose -f kafka-cluster.yml down -v\n")])])]),a("p",[t._v("Mount the directory containing the JMX Exporter agent to the Apache Kafka Docker container.")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" ./agents"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/agents\n")])])]),a("p",[t._v("Add to each of the Apache Kafka broker this environment variable.")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("KAFKA_OPTS")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"-javaagent:/agents/jmx_prometheus_javaagent-0.10.jar=7071:/agents/kafka.yaml"')]),t._v("\n")])])]),a("p",[t._v("It adds the Java agent to the broker and sets the HTTP server port to 7071.\nThe "),a("code",[t._v("kafka.yaml")]),t._v(" file defines the metrics to retrieve. As you can see, it only contains one metric to retrieve : "),a("code",[t._v("ActiveControllerCount")]),t._v(".")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("pattern")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" kafka.controller<type=KafkaController"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" name=ActiveControllerCount"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v("<"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v("Value\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" kafka_controller_active_controller_count\n")])])]),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),a("p",[t._v("More metrics will be added in the next part of this workshop.")])]),t._v(" "),a("p",[t._v("Once that's done, start the Apache Kafka cluster.")]),t._v(" "),a("div",{staticClass:"language-shell script extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("docker-compose -f kafka-cluster.yml up -d\n")])])]),a("p",[t._v("Before starting Prometheus database, edit its configuration file "),a("code",[t._v("prometheus.yml")]),t._v(" to add Apache Kafka and Apache ZooKeeper instances.")]),t._v(" "),a("details",[a("summary",[t._v("Afficher la réponse")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("div",{staticClass:"highlight-lines"},[a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("div",{staticClass:"highlighted"},[t._v(" ")]),a("br"),a("br"),a("br"),a("div",{staticClass:"highlighted"},[t._v(" ")]),a("br")]),a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("global")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("scrape_interval")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("     15s\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("evaluation_interval")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 15s\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("scrape_configs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("job_name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'prometheus'")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("scrape_interval")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 60s\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("static_configs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("targets")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'localhost:9090'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("job_name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'kafka'")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("scrape_interval")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 10s\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("static_configs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("targets")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'kafka-1:7071'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'kafka-2:7071'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'kafka-3:7071'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("job_name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'zookeeper'")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("scrape_interval")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 10s\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("static_configs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("targets")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'zk-1:7071'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'zk-2:7071'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'zk-3:7071'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])])]),t._v(" "),a("p",[t._v("Start Prometheus.")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("docker-compose -f prometheus-grafana.yml up -d\n")])])]),a("p",[t._v("Once Prometheus is started, go to "),a("a",{attrs:{href:"http://localhost:9090",target:"_blank",rel:"noopener noreferrer"}},[t._v("localhost:9090"),a("OutboundLink")],1),t._v(".")]),t._v(" "),a("p",[t._v("In section "),a("a",{attrs:{href:"http://localhost:9090/targets",target:"_blank",rel:"noopener noreferrer"}},[t._v("Status/Targets"),a("OutboundLink")],1),t._v(", you should see your Apache Kafka and Apache ZooKeeper instances.")]),t._v(" "),a("p",[a("img",{attrs:{src:"prometheus_targets.png",alt:"Prometheus Targets"}})]),t._v(" "),a("p",[t._v("Go to "),a("a",{attrs:{href:"http://localhost:9090/graph",target:"_blank",rel:"noopener noreferrer"}},[t._v("Graph"),a("OutboundLink")],1),t._v(" section and look for the Apache Kafka instance that is the controller of the cluster.")]),t._v(" "),a("p",[a("img",{attrs:{src:"active_controller.png",alt:"Active Controller"}})]),t._v(" "),a("p",[t._v("In fact, you don't need to spend your time creating the JMX Exporter configuration to scrap all the metrics.\nThe JMX Exporter project offers some "),a("a",{attrs:{href:"https://github.com/prometheus/jmx_exporter/tree/master/example_configs",target:"_blank",rel:"noopener noreferrer"}},[t._v("default configurations"),a("OutboundLink")],1),t._v(".")]),t._v(" "),a("p",[t._v("Grab the Apache Zookeeper configuration and the Apache Kafka configuration and apply it.")]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),a("p",[t._v("Can you find the important metrics listed in the previous chapter ?")])])])}),[],!1,null,null,null);e.default=r.exports}}]);